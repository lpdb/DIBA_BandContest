<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Giurato - DIBA BandContest</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        @media (max-width: 768px) {
            .bands-cards {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .band-card {
                background: var(--surface);
                border-radius: 12px;
                box-shadow: 0 2px 4px var(--shadow);
                padding: 1rem 1.25rem;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .band-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .band-card-title {
                font-weight: 600;
            }

            .band-card-subtitle {
                font-size: 0.85rem;
                color: var(--text-light);
            }

            .band-card-actions {
                margin-top: 0.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 0.5rem;
            }

            .band-card-actions-left {
                flex-shrink: 0;
            }

            .band-card-actions-right {
                flex-shrink: 0;
            }

            .bands-table-wrapper {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .bands-cards {
                display: none;
            }
            .bands-table-wrapper {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">üé∫ DIBA BandContest - Giurato</div>
        <div class="navbar-user">
            <span id="userEmail" style="margin-right: 1rem; color: var(--text-light);"></span>
            <a href="riepilogo-voti.html" class="btn btn-secondary" style="margin-right: 0.5rem;">
                Riepilogo Voti
            </a>
            <button onclick="handleLogout()" class="btn btn-outline">Esci</button>
        </div>
    </div>

    <div class="container">
        <div id="alert-container"></div>

        <div id="voting-status"></div>

        <div class="card">
            <h2>Seleziona la Banda da Valutare</h2>
            <p style="color: var(--text-light); margin-bottom: 2rem;">
                Scegli il giorno e la categoria, quindi seleziona la banda che vuoi giudicare
            </p>

            <div class="grid grid-2" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="filterDay">Giorno di Esibizione</label>
                    <select id="filterDay" class="form-control">
                        <option value="">Tutti i giorni</option>
                        <option value="sabato">Sabato</option>
                        <option value="domenica">Domenica</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="filterCategory">Categoria</label>
                    <select id="filterCategory" class="form-control">
                        <option value="">Tutte le categorie</option>
                    </select>
                </div>
            </div>

            <div id="bands-list" class="loading">Caricamento bande...</div>
        </div>
    </div>

    <script type="module">
        import { supabase, checkAuth, getUserProfile, logout, areVotingsClosed } from './supabase-client.js';

        let currentUser = null;
        let userProfile = null;
        let allBands = [];
        let categories = [];
        let votingsClosed = false;

        window.handleLogout = async () => {
            await logout();
        };

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
        }

        async function init() {
            currentUser = await checkAuth();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            userProfile = await getUserProfile(currentUser.id);
            if (!userProfile || userProfile.ruolo !== 'giurato') {
                showAlert('Accesso negato. Solo i giurati possono accedere a questa pagina.', 'danger');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            document.getElementById('userEmail').textContent = currentUser.email;

            votingsClosed = await areVotingsClosed();
            displayVotingStatus();

            await loadCategories();
            await loadBands();
            setupFilters();
        }

        function displayVotingStatus() {
            const statusDiv = document.getElementById('voting-status');
            if (votingsClosed) {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Le votazioni sono chiuse. Puoi solo consultare i voti gi√† espressi.
                    </div>
                `;
            } else {
                statusDiv.innerHTML = '';
            }
        }

        async function loadCategories() {
            const { data, error } = await supabase
                .from('categorie')
                .select('*')
                .order('ordinamento', { ascending: true })
                .order('nome', { ascending: true });

            if (error) {
                console.error('Errore caricamento categorie:', error);
                return;
            }

            categories = data || [];

            const select = document.getElementById('filterCategory');
            select.innerHTML = '<option value="">Tutte le categorie</option>';

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nome;
                select.appendChild(option);
            });
        }

        async function loadBands() {
            const { data, error } = await supabase
                .from('bande')
                .select(`
                    *,
                    categorie (
                        nome
                    )
                `)
                .order('data_esibizione')
                .order('nome');

            if (error) {
                console.error('Errore caricamento bande:', error);
                document.getElementById('bands-list').innerHTML = `
                    <div class="alert alert-danger">Errore nel caricamento delle bande</div>
                `;
                return;
            }

            allBands = data || [];

            const { data: votes, error: votesError } = await supabase
                .from('voti')
                .select('banda_id, tipo_brano, completato')
                .eq('giurato_id', currentUser.id);

            if (!votesError && votes) {
                allBands = allBands.map(band => {
                    const bandVotes = votes.filter(v => v.banda_id === band.id);
                    const obbligoVote = bandVotes.find(v => v.tipo_brano === 'obbligo');
                    const liberaVote = bandVotes.find(v => v.tipo_brano === 'libera_scelta');
                    
                    return {
                        ...band,
                        voto_obbligo_completato: obbligoVote?.completato || false,
                        voto_libera_completato: liberaVote?.completato || false,
                        completato: (obbligoVote?.completato && liberaVote?.completato) || false
                    };
                });
            }

            displayBands(allBands);
        }

        function setupFilters() {
            document.getElementById('filterDay').addEventListener('change', filterBands);
            document.getElementById('filterCategory').addEventListener('change', filterBands);
        }

        function filterBands() {
            const dayFilter = document.getElementById('filterDay').value;
            const categoryFilter = document.getElementById('filterCategory').value;

            let filtered = [...allBands];

            if (dayFilter) {
                filtered = filtered.filter(band => {
                    const day = new Date(band.data_esibizione).toLocaleDateString('it-IT', { weekday: 'long' });
                    return day.toLowerCase() === dayFilter.toLowerCase();
                });
            }

            if (categoryFilter) {
                filtered = filtered.filter(band => band.categoria_id === categoryFilter);
            }

            displayBands(filtered);
        }

        function getVoteStatusLabel(band) {
            if (band.completato) {
                return 'Completato';
            } else if (band.voto_obbligo_completato || band.voto_libera_completato) {
                return 'Parziale';
            } else {
                return 'Da votare';
            }
        }

        function getVoteStatusBadge(band) {
            const label = getVoteStatusLabel(band);
            if (band.completato) {
                return `<span class="badge badge-success">${label}</span>`;
            } else if (band.voto_obbligo_completato || band.voto_libera_completato) {
                return `<span class="badge badge-warning">${label}</span>`;
            } else {
                return `<span class="badge badge-danger">${label}</span>`;
            }
        }

        function formatDateShort(dateString) {
            const d = new Date(dateString);
            const dayName = d.toLocaleDateString('it-IT', { weekday: 'long' });
            const datePart = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return `${dayName} ${datePart}`;
        }

        function displayBands(bands) {
            const container = document.getElementById('bands-list');

            if (bands.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        Nessuna banda trovata con i filtri selezionati
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="bands-table-wrapper">
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Banda</th>
                                    <th>Stato Voto</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bands.map(band => `
                                    <tr>
                                        <td>
                                            <strong>${band.nome}</strong><br>
                                            <small style="color: var(--text-light);">
                                                ${band.categorie?.nome || ''} ¬∑ ${formatDateShort(band.data_esibizione)}
                                            </small>
                                        </td>
                                        <td>${getVoteStatusBadge(band)}</td>
                                        <td>
                                            <button 
                                                onclick="voteBand('${band.id}')" 
                                                class="btn btn-primary"
                                                style="font-size: 0.875rem; padding: 0.5rem 1rem;"
                                            >
                                                ${band.completato ? 'Modifica' : 'Vota'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bands-cards">
                    ${bands.map(band => `
                        <div class="band-card">
                            <div class="band-card-header">
                                <div>
                                    <div class="band-card-title">${band.nome}</div>
                                    <div class="band-card-subtitle">
                                        ${band.categorie?.nome || ''} ¬∑ ${formatDateShort(band.data_esibizione)}
                                    </div>
                                </div>
                            </div>
                            <div class="band-card-actions">
                                <div class="band-card-actions-left">
                                    <button 
                                        onclick="voteBand('${band.id}')" 
                                        class="btn btn-primary"
                                        style="font-size: 0.9rem; padding: 0.4rem 0.9rem;"
                                    >
                                        ${band.completato ? 'Modifica' : 'Vota'}
                                    </button>
                                </div>
                                <div class="band-card-actions-right">
                                    ${getVoteStatusBadge(band)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.voteBand = (bandId) => {
            window.location.href = `vota-banda.html?id=${bandId}`;
        };

        init();
    </script>
</body>
</html>
